#!/usr/bin/env bash
# Script to configure GRUB BigCommunity theme
# Triggered by pacman hook on grub or grub-theme-community installation/upgrade

# Color definitions for status messages
blueDark="\e[1;38;5;33m"     # Bold dark blue
mediumBlue="\e[1;38;5;32m"   # Bold medium blue
lightBlue="\e[1;38;5;39m"    # Bold light blue
cyan="\e[1;38;5;45m"         # Bold cyan
white="\e[1;97m"             # Bold white
reset="\e[0m"                # Reset text formatting

# Additional colors for warnings/errors
red="\e[1;31m"               # Bold red for errors
yellow="\e[1;33m"            # Bold yellow for warnings
green="\e[1;32m"             # Bold green for success

# Print status messages
printMsg() {
    local message=$1
    echo -e "${blueDark}[${lightBlue}grub-theme-community${blueDark}]${reset} ${cyan}→${reset} ${white}${message}${reset}"
}

# Print success messages
printOk() {
    local message="$1"
    echo -e "${blueDark}[${green}SUCCESS${blueDark}]${reset} ${cyan}→${reset} ${white}${message}${reset}"
}

# Print warning messages
printWarn() {
    local message="$1"
    echo -e "${blueDark}[${yellow}WARNING${blueDark}]${reset} ${cyan}→${reset} ${white}${message}${reset}"
}

# Print error messages
printErr() {
    local message="$1"
    echo -e "${blueDark}[${red}ERROR${blueDark}]${reset} ${cyan}→${reset} ${white}${message}${reset}"
}

# Theme configuration
GRUB_CONFIG="/etc/default/grub"
THEME_PATH="/boot/grub/themes/community/theme.txt"

# Check if we are in a live environment (skip configuration)
if [ -e /usr/bin/startbiglive ]; then
    printMsg "Live environment detected, skipping GRUB theme configuration"
    exit 0
fi

# Check if GRUB config file exists
if [ ! -f "$GRUB_CONFIG" ]; then
    printWarn "GRUB configuration file not found at $GRUB_CONFIG"
    printWarn "Skipping theme configuration"
    exit 0
fi

# Check if theme file exists
if [ ! -f "$THEME_PATH" ]; then
    printErr "Theme file not found at $THEME_PATH"
    exit 1
fi

printMsg "Configuring GRUB theme..."

# Configure GRUB_THEME variable
if ! grep -q 'GRUB_THEME=' "$GRUB_CONFIG"; then
    # GRUB_THEME variable doesn't exist, add it
    echo "GRUB_THEME=\"$THEME_PATH\"" >> "$GRUB_CONFIG"
    printMsg "Added GRUB_THEME to $GRUB_CONFIG"
else
    # GRUB_THEME variable exists, update it
    sed -i "s|^ *\bGRUB_THEME\b *=.*|GRUB_THEME=\"$THEME_PATH\"|" "$GRUB_CONFIG"
    printMsg "Updated GRUB_THEME in $GRUB_CONFIG"
fi

# Update GRUB configuration
printMsg "Updating GRUB configuration..."
if command -v update-grub &> /dev/null; then
    update-grub
    printOk "GRUB configuration updated successfully using update-grub"
elif command -v grub-mkconfig &> /dev/null; then
    grub-mkconfig -o /boot/grub/grub.cfg
    printOk "GRUB configuration updated successfully using grub-mkconfig"
else
    printWarn "Unable to update GRUB configuration automatically."
    printWarn "Please run 'update-grub' or 'grub-mkconfig -o /boot/grub/grub.cfg' manually"
fi

printOk "GRUB BigCommunity theme configured successfully"
exit 0
